async function toB64(f,maxW=640,maxH=640,q=0.72){return new Promise((res,rej)=>{const i=new Image(),r=new FileReader();r.onload=e=>{i.onload=()=>{const t=Math.min(maxW/i.width,maxH/i.height,1),c=document.createElement('canvas');c.width=Math.round(i.width*t);c.height=Math.round(i.height*t);c.getContext('2d').drawImage(i,0,0,c.width,c.height);res(c.toDataURL('image/jpeg',q))};i.src=e.target.result};r.onerror=rej;r.readAsDataURL(f)})}
async function loadProfile(){const d=await api('getMyProfile');document.getElementById('fullname').value=d.fullname||'';document.getElementById('dept').value=d.dept||'';document.getElementById('title').value=d.title||'';}
document.getElementById('pf').addEventListener('submit', async (e)=>{e.preventDefault();const fullname=document.getElementById('fullname').value;const dept=document.getElementById('dept').value;const title=document.getElementById('title').value;const f=document.getElementById('photo').files[0];let photoBase64='';if(f){photoBase64=await toB64(f)}try{await api('updateMyProfile',{payload:{fullname,dept,title,photoBase64}});alert('บันทึกโปรไฟล์แล้ว')}catch(err){alert(err.message);}});
document.getElementById('pwf').addEventListener('submit', async (e)=>{e.preventDefault();const oldPassword=document.getElementById('oldpass').value;const newPassword=document.getElementById('newpass').value;try{await api('updateMyPassword',{payload:{oldPassword,newPassword}});alert('เปลี่ยนรหัสผ่านสำเร็จ');e.target.reset()}catch(err){alert(err.message);}});
document.addEventListener('DOMContentLoaded', loadProfile);
